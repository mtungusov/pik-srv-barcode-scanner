#!/usr/bin/env jruby
# Run: export BARCODE_SCANNER_ENV=development && ./bin/srv-start

if ENV['BARCODE_SCANNER_ENV']
  require 'pry'

  $: << File.join(File.dirname(__FILE__), '..')
  puts "RUN in: #{ENV['BARCODE_SCANNER_ENV']}"

  require 'config/config'
  $config = Configuration.load_config(ENV['BARCODE_SCANNER_ENV'])

  $zk_con = ENV['ZOOKEEPER_CONNECTION'] ? ENV['ZOOKEEPER_CONNECTION'] : $config['connection']['zookeeper']
  $kf_con = ENV['KAFKA_CONNECTION'] ? ENV['KAFKA_CONNECTION'] : $config['connection']['kafka']
  $sr_con = ENV['SCHEMA_REGISTRY_CONNECTION'] ? ENV['SCHEMA_REGISTRY_CONNECTION'] : $config['connection']['schema-registry']


  require 'java'
  ENV['CLASSPATH'] = "./vendor/java/schema-registry/*"
  # binding.pry

  require 'json'
  # require 'celluloid'


  $: << 'lib'
  require 'producer'

  $RUNNING = true

  trap('SIGINT') do
    $RUNNING = false
  end

  PRODUCER = Producer::open

  while $RUNNING
    Producer::produce_random(PRODUCER)
    sleep 1.0
  end

  puts "Wait 10 sec for clear shutdown"
  sleep 10.0

  PRODUCER.close

  puts "SHUTDOWN in #{Time.now}"
  exit


else
  puts 'Error: not found "BARCODE_SCANNER_ENV"!'
end
